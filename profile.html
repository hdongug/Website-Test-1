<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>게임 거래소 - 프로필</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f9fafb;
      color: #333;
    }
    
    /* 헤더 스타일 */
    header {
      background-color: #8e44ad;
      color: white;
    }
    
    /* 버튼 스타일 */
    .btn-primary {
      background-color: #8e44ad;
      color: white;
      padding: 0.5rem 1.5rem;
      border-radius: 0.375rem;
      font-weight: 500;
      transition: background-color 0.3s;
    }
    .btn-primary:hover {
      background-color: #7d3c98;
    }
  </style>
</head>
<body class="bg-gray-100">
  <!-- 헤더 -->
  <header class="bg-purple-600 text-white">
    <div class="container mx-auto px-4">
      <div class="flex justify-between items-center py-3">
        <a href="index.html" class="flex items-center">
          <h1 class="text-xl font-bold">게임 거래소</h1>
        </a>
        
        <!-- 상단 메뉴 -->
        <div class="flex items-center space-x-5 text-sm">
          <a href="market.html" class="text-white hover:text-gray-200">거래소</a>
          <a href="board.html" class="text-white hover:text-gray-200">게시판</a>
          <a href="attendance.html" class="text-white hover:text-gray-200">출석체크</a>
          <a href="profile.html" class="text-white hover:text-gray-200" id="profileLink">프로필</a>
          <a href="login.html" class="text-white hover:text-gray-200" id="loginBtn">로그인</a>
          <button id="menuBtn" class="text-white hover:text-gray-200 focus:outline-none">
            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- 사이드 메뉴 -->
  <div id="sideMenu" class="fixed top-0 bottom-0 right-0 w-64 bg-white transform translate-x-full transition-transform duration-300 ease-in-out shadow-lg z-50">
    <div class="p-4">
      <div class="flex flex-col space-y-2">
        <a href="board.html" class="text-gray-700 hover:text-purple-600 flex items-center py-2 px-3 rounded-md hover:bg-gray-100">
          <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
          </svg>
          게시판
        </a>
        <a href="inventory.html" class="text-gray-700 hover:text-purple-600 flex items-center py-2 px-3 rounded-md hover:bg-gray-100">
          <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
          </svg>
          창고
        </a>
        <a href="profile.html" class="text-purple-600 font-medium flex items-center py-2 px-3 rounded-md hover:bg-gray-100">
          <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
          사용자정보
        </a>
        <a href="#" id="logoutBtn" class="text-gray-700 hover:text-red-600 flex items-center py-2 px-3 rounded-md hover:bg-gray-100">
          <svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
          </svg>
          로그아웃
        </a>
      </div>
    </div>
  </div>

  <!-- 회사 이름 표시 바 -->
  <div class="bg-white shadow-sm">
    <div class="container mx-auto px-4">
      <div class="flex items-center py-2">
        <svg class="h-4 w-4 text-blue-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span class="text-sm text-gray-600">내 프로필</span>
      </div>
    </div>
  </div>

  <div class="container mx-auto px-4 py-6">
    <!-- 비로그인 상태 -->
    <div id="not-logged-in" class="bg-white p-8 rounded-lg shadow-md text-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-purple-400 mx-auto mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
      </svg>
      <h2 class="text-2xl font-bold mb-4">로그인이 필요합니다</h2>
      <p class="text-gray-600 mb-4">프로필 정보를 보려면 로그인하세요.</p>
      <a href="login.html" class="btn-primary inline-block">로그인 하기</a>
    </div>

    <!-- 로그인 상태 -->
    <div id="user-profile" class="hidden space-y-8">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-900">사용자 정보</h1>
      </div>

      <!-- 사용자 정보 카드 -->
      <div class="bg-white shadow overflow-hidden rounded-lg divide-y divide-gray-200">
        <div class="px-4 py-5 sm:px-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900">개인정보</h3>
        </div>
        <div class="px-4 py-5 sm:p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <div class="text-sm font-medium text-gray-500 mb-1">닉네임</div>
              <div class="flex items-center">
                <span id="userName" class="font-medium text-gray-900 mr-2">-</span>
                <button id="nicknameChangeBtn" class="text-xs bg-purple-600 text-white px-2 py-1 rounded hover:bg-purple-700 transition-colors">닉네임 변경</button>
              </div>
            </div>
            <div>
              <div class="text-sm font-medium text-gray-500 mb-1">재화</div>
              <div id="userCurrency" class="font-medium text-gray-900">-</div>
            </div>
            <div>
              <div class="text-sm font-medium text-gray-500 mb-1">비밀번호</div>
              <div class="flex items-center">
                <span id="userPassword" class="font-medium text-gray-900 mr-2">********</span>
                <button id="passwordChangeBtn" class="text-xs bg-purple-600 text-white px-2 py-1 rounded hover:bg-purple-700 transition-colors">비밀번호 변경</button>
              </div>
            </div>
            <div>
              <div class="text-sm font-medium text-gray-500 mb-1">가입일</div>
              <div id="userJoinDate" class="font-medium text-gray-900">-</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 친구 목록 -->
      <div class="bg-white shadow overflow-hidden rounded-lg">
        <div class="px-4 py-5">
          <h3 class="text-lg leading-6 font-medium text-gray-900">친구 목록</h3>
        </div>
        <div class="border-t border-gray-200 p-4">
          <div class="mb-4">
            <div class="flex space-x-2">
              <input type="text" id="friendUsername" placeholder="친구 추가" class="border rounded px-3 py-2 text-sm flex-grow">
              <button id="addFriendBtn" class="bg-purple-600 text-white px-3 py-2 rounded text-sm hover:bg-purple-700">추가</button>
            </div>
          </div>
          <ul class="space-y-3" id="friendsList">
            <li class="text-gray-500 text-center py-4">친구가 없습니다</li>
          </ul>
        </div>
      </div>
      
      <!-- 친구 요청 -->
      <div class="bg-white shadow overflow-hidden rounded-lg mt-4">
        <div class="px-4 py-5">
          <h3 class="text-lg leading-6 font-medium text-gray-900">친구 요청</h3>
        </div>
        <div class="border-t border-gray-200 p-4">
          <ul class="space-y-2" id="friendRequests">
            <li class="text-gray-500 text-center py-4">새 친구 요청이 없습니다</li>
          </ul>
        </div>
      </div>

      <!-- 최근 거래 내역 -->
      <div class="bg-white shadow overflow-hidden rounded-lg">
        <div class="px-4 py-5">
          <h3 class="text-lg leading-6 font-medium text-gray-900">최근 거래 내역</h3>
        </div>
        <div class="border-t border-gray-200">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">날짜</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">아이템</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">가격</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="transactionList">
              <!-- 트랜잭션 기록이 여기에 들어갑니다 -->
            </tbody>
          </table>
          <div id="noTransactions" class="px-6 py-4 text-center text-gray-500">
            아직 거래 내역이 없습니다.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 닉네임 변경 모달 -->
  <div id="nicknameModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium text-gray-900">닉네임 변경</h3>
        <button id="closeNicknameModal" class="text-gray-400 hover:text-gray-500">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="mt-2">
        <p class="text-sm text-gray-500">닉네임 변경에는 1,000 재화가 소비됩니다.</p>
        <div class="mt-4">
          <input id="newNickname" type="text" placeholder="새 닉네임" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-600 focus:border-transparent">
        </div>
      </div>
      <div class="mt-5 flex justify-end space-x-3">
        <button id="confirmNicknameChange" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition-colors">변경하기</button>
        <button id="cancelNicknameChange" class="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300 transition-colors">취소</button>
      </div>
    </div>
  </div>

  <!-- 비밀번호 변경 모달 -->
  <div id="passwordModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium text-gray-900">비밀번호 변경</h3>
        <button id="closePasswordModal" class="text-gray-400 hover:text-gray-500">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="mt-2">
        <p class="text-sm text-gray-500">안전한 비밀번호로 변경하십시오.</p>
        <div class="mt-4 space-y-3">
          <input id="currentPassword" type="password" placeholder="현재 비밀번호" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-600 focus:border-transparent">
          <input id="newPassword" type="password" placeholder="새 비밀번호" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-600 focus:border-transparent">
          <input id="confirmPassword" type="password" placeholder="비밀번호 확인" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-600 focus:border-transparent">
        </div>
      </div>
      <div class="mt-5 flex justify-end space-x-3">
        <button id="confirmPasswordChange" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition-colors">변경하기</button>
        <button id="cancelPasswordChange" class="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300 transition-colors">취소</button>
      </div>
    </div>
  </div>

  <script>
    // 친구 관리 함수
    // 친구 목록 가져오기
    function getFriendsList(username) {
      const friendsKey = `friends_${username}`;
      const storedFriends = localStorage.getItem(friendsKey);
      
      if (storedFriends) {
        try {
          return JSON.parse(storedFriends);
        } catch (e) {
          console.error('친구 목록 변환 오류:', e);
        }
      }
      
      return [];
    }
    
    // 친구 목록 저장
    function saveFriendsList(username, friends) {
      const friendsKey = `friends_${username}`;
      localStorage.setItem(friendsKey, JSON.stringify(friends));
      
      // 서버에 저장 (허가)
      console.log(`사용자 ${username}의 친구 목록이 저장되었습니다.`, friends);
    }
    
    // 친구 요청 목록 가져오기
    function getFriendRequests(username) {
      const requestsKey = `friendRequests_${username}`;
      const storedRequests = localStorage.getItem(requestsKey);
      
      if (storedRequests) {
        try {
          return JSON.parse(storedRequests);
        } catch (e) {
          console.error('친구 요청 목록 변환 오류:', e);
        }
      }
      
      return [];
    }
    
    // 친구 요청 목록 저장
    function saveFriendRequests(username, requests) {
      const requestsKey = `friendRequests_${username}`;
      localStorage.setItem(requestsKey, JSON.stringify(requests));
    }
    
    // 사용자 친구 목록 렌더링
    function renderFriendsList(friends) {
      const friendsList = document.getElementById('friendsList');
      if (!friendsList) return;
      
      if (!friends || friends.length === 0) {
        friendsList.innerHTML = '<li class="text-gray-500 text-center py-4">친구가 없습니다</li>';
        return;
      }
      
      friendsList.innerHTML = '';
      
      friends.forEach(friend => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between bg-gray-50 rounded p-3';
        li.innerHTML = `
          <div class="flex items-center">
            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-3">
              <span class="text-purple-600 font-medium">${friend.name ? friend.name.charAt(0).toUpperCase() : 'U'}</span>
            </div>
            <div>
              <span class="font-medium">${friend.name || '사용자'}</span>
              <span class="text-xs text-gray-500 block">${friend.username}</span>
            </div>
          </div>
          <button class="delete-friend-btn text-sm text-red-500 hover:text-red-700" data-username="${friend.username}">삭제</button>
        `;
        
        friendsList.appendChild(li);
      });
      
      // 친구 삭제 버튼 이벤트 등록
      const deleteButtons = document.querySelectorAll('.delete-friend-btn');
      deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
          const friendUsername = this.dataset.username;
          if (confirm(`${friendUsername} 님을 친구 목록에서 삭제하시겠습니까?`)) {
            const user = JSON.parse(localStorage.getItem('user'));
            const updatedFriends = getFriendsList(user.username).filter(f => f.username !== friendUsername);
            saveFriendsList(user.username, updatedFriends);
            renderFriendsList(updatedFriends);
            showToast(`${friendUsername} 님을 친구 목록에서 삭제했습니다.`);
          }
        });
      });
    }
    
    // 친구 요청 목록 렌더링
    function renderFriendRequests(requests) {
      const requestsList = document.getElementById('friendRequests');
      if (!requestsList) return;
      
      if (!requests || requests.length === 0) {
        requestsList.innerHTML = '<li class="text-gray-500 text-center py-4">새 친구 요청이 없습니다</li>';
        return;
      }
      
      requestsList.innerHTML = '';
      
      requests.forEach(request => {
        const li = document.createElement('li');
        li.className = 'bg-gray-50 rounded p-3';
        li.innerHTML = `
          <div class="flex items-center mb-2">
            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-3">
              <span class="text-purple-600 font-medium">${request.name ? request.name.charAt(0).toUpperCase() : 'U'}</span>
            </div>
            <div>
              <span class="font-medium">${request.name || '사용자'}</span>
              <span class="text-xs text-gray-500 block">${request.username}</span>
            </div>
          </div>
          <div class="flex space-x-2">
            <button class="accept-friend-btn text-sm bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600" data-username="${request.username}" data-name="${request.name || '사용자'}">수락</button>
            <button class="reject-friend-btn text-sm bg-gray-300 text-gray-700 px-3 py-1 rounded hover:bg-gray-400" data-username="${request.username}">거절</button>
          </div>
        `;
        
        requestsList.appendChild(li);
      });
      
      // 친구 요청 수락 버튼 이벤트 등록
      const user = JSON.parse(localStorage.getItem('user'));
      const acceptButtons = document.querySelectorAll('.accept-friend-btn');
      acceptButtons.forEach(button => {
        button.addEventListener('click', function() {
          const friendUsername = this.dataset.username;
          const friendName = this.dataset.name;
          
          // 친구 요청 목록에서 제거
          const updatedRequests = getFriendRequests(user.username).filter(r => r.username !== friendUsername);
          saveFriendRequests(user.username, updatedRequests);
          
          // 친구 목록에 추가
          const currentFriends = getFriendsList(user.username);
          if (!currentFriends.some(f => f.username === friendUsername)) {
            currentFriends.push({
              username: friendUsername,
              name: friendName,
              date: new Date().toISOString()
            });
            saveFriendsList(user.username, currentFriends);
          }
          
          // UI 업데이트
          renderFriendRequests(updatedRequests);
          renderFriendsList(currentFriends);
          showToast(`${friendName} 님과 친구가 되었습니다!`);
        });
      });
      
      // 친구 요청 거절 버튼 이벤트 등록
      const rejectButtons = document.querySelectorAll('.reject-friend-btn');
      rejectButtons.forEach(button => {
        button.addEventListener('click', function() {
          const friendUsername = this.dataset.username;
          
          // 친구 요청 목록에서 제거
          const updatedRequests = getFriendRequests(user.username).filter(r => r.username !== friendUsername);
          saveFriendRequests(user.username, updatedRequests);
          
          // UI 업데이트
          renderFriendRequests(updatedRequests);
          showToast(`친구 요청을 거절했습니다.`);
        });
      });
    }
    
    // 토스트 메시지 표시 함수
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-md z-50 transition-opacity duration-300 opacity-0';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('opacity-100'), 10);
      setTimeout(() => toast.classList.remove('opacity-100'), 3000);
      setTimeout(() => document.body.removeChild(toast), 3500);
    }

    // 가상의 사용자 데이터 확인 (실제로는 서버 API 사용 필요)
    function checkUserExists(username) {
      const users = ['admin', 'user1', 'user2', 'test', 'demo']; // 가상의 사용자 목록
      return users.includes(username) || localStorage.getItem(`userNumber_${username}`) !== null;
    }
    
    // 가상의 사용자 정보 가져오기
    function getSimulatedUser(username) {
      let displayName;
      
      if (username === 'admin') {
        displayName = '관리자1';
      } else {
        const userNumber = localStorage.getItem(`userNumber_${username}`) || Math.floor(Math.random() * 100 + 1);
        displayName = `유저${userNumber}`;
        localStorage.setItem(`userNumber_${username}`, userNumber);
      }
      
      return {
        username: username,
        name: displayName,
        joinDate: '2025-05-01'
      };
    }

    // 메뉴 버튼 처리
    const menuBtn = document.getElementById('menuBtn');
    const sideMenu = document.getElementById('sideMenu');
    const overlay = document.createElement('div');
    overlay.classList.add('fixed', 'inset-0', 'bg-black', 'bg-opacity-25', 'z-40', 'hidden');
    document.body.appendChild(overlay);

    menuBtn.addEventListener('click', function() {
      sideMenu.classList.remove('translate-x-full');
      sideMenu.classList.add('translate-x-0');
      overlay.classList.remove('hidden');
    });

    overlay.addEventListener('click', function() {
      sideMenu.classList.remove('translate-x-0');
      sideMenu.classList.add('translate-x-full');
      overlay.classList.add('hidden');
    });

    // 로그인 상태 확인 및 화면 업데이트
    // 친구 관리 함수들
    // 친구 목록 가져오기
    function getFriendsList(username) {
      const friendsKey = `friends_${username}`;
      const storedFriends = localStorage.getItem(friendsKey);
      
      if (storedFriends) {
        try {
          return JSON.parse(storedFriends);
        } catch (e) {
          console.error('친구 목록 변환 오류:', e);
        }
      }
      
      return [];
    }
    
    // 친구 목록 저장
    function saveFriendsList(username, friends) {
      const friendsKey = `friends_${username}`;
      localStorage.setItem(friendsKey, JSON.stringify(friends));
      
      // 서버에 저장
      saveFriendsToServer(username, friends);
    }
    
    // 서버에 친구 목록 저장 (가상)
    function saveFriendsToServer(username, friends) {
      console.log(`사용자 ${username}의 친구 목록이 서버에 저장되었습니다.`, friends);
      
      // AJAX 요청 예시
      /*
      fetch('/api/friends/save', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          username: username,
          friends: friends
        })
      })
      .then(response => response.json())
      .then(data => console.log('서버 응답:', data))
      .catch(error => console.error('서버 연동 오류:', error));
      */
    }
    
    // 친구 요청 목록 가져오기
    function getFriendRequests(username) {
      const requestsKey = `friendRequests_${username}`;
      const storedRequests = localStorage.getItem(requestsKey);
      
      if (storedRequests) {
        try {
          return JSON.parse(storedRequests);
        } catch (e) {
          console.error('친구 요청 목록 변환 오류:', e);
        }
      }
      
      return [];
    }
    
    // 친구 요청 목록 저장
    function saveFriendRequests(username, requests) {
      const requestsKey = `friendRequests_${username}`;
      localStorage.setItem(requestsKey, JSON.stringify(requests));
    }
    
    // 사용자 친구 목록 렌더링
    function renderFriendsList(friends, currentUsername) {
      const friendsList = document.getElementById('friendsList');
      if (!friendsList) return;
      
      if (friends.length === 0) {
        friendsList.innerHTML = '<li class="text-gray-500 text-center py-4">친구가 없습니다</li>';
        return;
      }
      
      friendsList.innerHTML = '';
      
      friends.forEach(friend => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between bg-gray-50 rounded p-3';
        li.innerHTML = `
          <div class="flex items-center">
            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-3">
              <span class="text-purple-600 font-medium">${friend.name.charAt(0).toUpperCase()}</span>
            </div>
            <div>
              <span class="font-medium">${friend.name}</span>
              <span class="text-xs text-gray-500 block">${friend.username}</span>
            </div>
          </div>
          <button class="delete-friend-btn text-sm text-red-500 hover:text-red-700" data-username="${friend.username}">삭제</button>
        `;
        
        friendsList.appendChild(li);
      });
      
      // 친구 삭제 버튼 이벤트 등록
      const deleteButtons = document.querySelectorAll('.delete-friend-btn');
      deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
          const friendUsername = this.dataset.username;
          if (confirm(`${friendUsername} 님을 친구 목록에서 삭제하시겠습니까?`)) {
            const updatedFriends = friends.filter(f => f.username !== friendUsername);
            saveFriendsList(currentUsername, updatedFriends);
            renderFriendsList(updatedFriends, currentUsername);
            showToast(`${friendUsername} 님을 친구 목록에서 삭제했습니다.`);
          }
        });
      });
    }
    
    // 친구 요청 목록 렌더링
    function renderFriendRequests(requests, currentUsername) {
      const requestsList = document.getElementById('friendRequests');
      if (!requestsList) return;
      
      if (requests.length === 0) {
        requestsList.innerHTML = '<li class="text-gray-500 text-center py-4">새 친구 요청이 없습니다</li>';
        return;
      }
      
      requestsList.innerHTML = '';
      
      requests.forEach(request => {
        const li = document.createElement('li');
        li.className = 'bg-gray-50 rounded p-3';
        li.innerHTML = `
          <div class="flex items-center mb-2">
            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-3">
              <span class="text-purple-600 font-medium">${request.name.charAt(0).toUpperCase()}</span>
            </div>
            <div>
              <span class="font-medium">${request.name}</span>
              <span class="text-xs text-gray-500 block">${request.username}</span>
            </div>
          </div>
          <div class="flex space-x-2">
            <button class="accept-friend-btn text-sm bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600" data-username="${request.username}" data-name="${request.name}">수락</button>
            <button class="reject-friend-btn text-sm bg-gray-300 text-gray-700 px-3 py-1 rounded hover:bg-gray-400" data-username="${request.username}">거절</button>
          </div>
        `;
        
        requestsList.appendChild(li);
      });
      
      // 친구 요청 수락 버튼 이벤트 등록
      const acceptButtons = document.querySelectorAll('.accept-friend-btn');
      acceptButtons.forEach(button => {
        button.addEventListener('click', function() {
          const friendUsername = this.dataset.username;
          const friendName = this.dataset.name;
          
          // 친구 요청 목록에서 제거
          const updatedRequests = requests.filter(r => r.username !== friendUsername);
          saveFriendRequests(currentUsername, updatedRequests);
          
          // 친구 목록에 추가
          const currentFriends = getFriendsList(currentUsername);
          if (!currentFriends.some(f => f.username === friendUsername)) {
            currentFriends.push({
              username: friendUsername,
              name: friendName,
              date: new Date().toISOString()
            });
            saveFriendsList(currentUsername, currentFriends);
          }
          
          // UI 업데이트
          renderFriendRequests(updatedRequests, currentUsername);
          renderFriendsList(currentFriends, currentUsername);
          showToast(`${friendName} 님과 친구가 되었습니다!`);
        });
      });
      
      // 친구 요청 거절 버튼 이벤트 등록
      const rejectButtons = document.querySelectorAll('.reject-friend-btn');
      rejectButtons.forEach(button => {
        button.addEventListener('click', function() {
          const friendUsername = this.dataset.username;
          
          // 친구 요청 목록에서 제거
          const updatedRequests = requests.filter(r => r.username !== friendUsername);
          saveFriendRequests(currentUsername, updatedRequests);
          
          // UI 업데이트
          renderFriendRequests(updatedRequests, currentUsername);
          showToast(`친구 요청을 거절했습니다.`);
        });
      });
    }
    
    // 토스트 메시지 표시 함수
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-md z-50 transition-opacity duration-300 opacity-0';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('opacity-100'), 10);
      setTimeout(() => toast.classList.remove('opacity-100'), 3000);
      setTimeout(() => document.body.removeChild(toast), 3500);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      const user = JSON.parse(localStorage.getItem('user') || 'null');
      const loginBtn = document.getElementById('loginBtn');
      const profileLink = document.getElementById('profileLink');
      const logoutBtn = document.getElementById('logoutBtn');
      const notLoggedIn = document.getElementById('not-logged-in');
      const userProfile = document.getElementById('user-profile');

      if (user) {
        // 로그인 상태
        loginBtn.classList.add('hidden');
        profileLink.classList.remove('hidden');
        logoutBtn.addEventListener('click', function(e) {
          e.preventDefault();
          localStorage.removeItem('user');
          alert('로그아웃 되었습니다.');
          window.location.reload();
        });

        // 프로필 페이지 표시
        notLoggedIn.classList.add('hidden');
        userProfile.classList.remove('hidden');

        // 유저 정보 표시 - 닉네임 표시 방식 변경
        const username = user.username;
        let displayName = user.name || '';
        
        // 닉네임이 없으면 사용자명 기반으로 생성
        if (!displayName || displayName === '닉네임 없음') {
          if (username === 'admin') {
            displayName = '관리자1'; // admin은 관리자1로 표시
          } else {
            // 다른 사용자는 유저 + 번호로 표시
            // 이미 저장된 닉네임 번호를 확인
            const userCountKey = 'userCount';
            let userCount = parseInt(localStorage.getItem(userCountKey) || '1');
            
            // 특정 사용자에게 이미 할당된 번호가 있는지 확인
            const userNumberKey = `userNumber_${username}`;
            let userNumber = localStorage.getItem(userNumberKey);
            
            if (!userNumber) {
              userNumber = userCount.toString();
              localStorage.setItem(userNumberKey, userNumber);
              localStorage.setItem(userCountKey, (userCount + 1).toString());
            }
            
            displayName = `유저${userNumber}`;
          }
          
          // 생성된 닉네임 저장
          user.name = displayName;
          localStorage.setItem('user', JSON.stringify(user));
        }
        
        document.getElementById('userName').textContent = displayName;
        document.getElementById('userCurrency').textContent = user.currency ? `${user.currency.toLocaleString()} 재화` : '0 재화';
        document.getElementById('userJoinDate').textContent = user.joinDate || '2025-04-22';
        
        // 비밀번호 별표(비밀번호 길이에 맞게 표시)
        document.getElementById('userPassword').textContent = user.password ? '*'.repeat(user.password.length) : '********';
        
        // 친구 목록 로드 및 표시
        const friends = getFriendsList(username);
        renderFriendsList(friends);
        
        // 친구 요청 목록 로드 및 표시
        const requests = getFriendRequests(username);
        renderFriendRequests(requests);
        
        // 친구 추가 버튼 이벤트 등록
        const addFriendBtn = document.getElementById('addFriendBtn');
        const friendUsernameInput = document.getElementById('friendUsername');
        
        if (addFriendBtn && friendUsernameInput) {
          addFriendBtn.addEventListener('click', function() {
            const targetUsername = friendUsernameInput.value.trim();
            
            if (!targetUsername) {
              showToast('친구로 추가할 사용자 이름을 입력해주세요.');
              return;
            }
            
            // 자기 자신을 추가하려는 경우 처리
            if (targetUsername === username) {
              showToast('자기 자신을 친구로 추가할 수 없습니다.');
              return;
            }
            
            // 사용자 존재 확인 (실제로는 서버 API로 확인 필요)
            if (!checkUserExists(targetUsername)) {
              showToast('존재하지 않는 사용자입니다.');
              return;
            }
            
            // 이미 친구인지 확인
            if (friends.some(f => f.username === targetUsername)) {
              showToast('이미 친구로 등록된 사용자입니다.');
              return;
            }
            
            // 가상 사용자 정보 생성 (실제로는 서버에서 가져와야 함)
            const targetUser = getSimulatedUser(targetUsername);
            
            // 친구 요청 목록 가져오기 (실제로는 서버에서 다른 로직 필요)
            const targetUserRequests = getFriendRequests(targetUsername);
            
            // 이미 요청했는지 확인
            if (targetUserRequests.some(r => r.username === username)) {
              showToast('이미 친구 요청을 보냈습니다.');
              return;
            }
            
            // 친구 요청 추가
            targetUserRequests.push({
              username: username,
              name: displayName,
              date: new Date().toISOString()
            });
            
            // 저장
            saveFriendRequests(targetUsername, targetUserRequests);
            
            // 입력창 초기화
            friendUsernameInput.value = '';
            
            showToast(`${targetUsername} 님에게 친구 요청을 보냈습니다.`);
          });
        }
        
        // 닉네임 변경 버튼 이벤트 리스너
        const nicknameChangeBtn = document.getElementById('nicknameChangeBtn');
        const nicknameModal = document.getElementById('nicknameModal');
        const closeNicknameModal = document.getElementById('closeNicknameModal');
        const confirmNicknameChange = document.getElementById('confirmNicknameChange');
        const cancelNicknameChange = document.getElementById('cancelNicknameChange');
        
        // 닉네임 변경 모달 열기
        nicknameChangeBtn.addEventListener('click', function() {
          nicknameModal.classList.remove('hidden');
          document.getElementById('newNickname').focus();
        });
        
        // 닉네임 변경 모달 닫기
        closeNicknameModal.addEventListener('click', function() {
          nicknameModal.classList.add('hidden');
        });
        
        cancelNicknameChange.addEventListener('click', function() {
          nicknameModal.classList.add('hidden');
        });
        
        // 닉네임 변경 확인 처리
        confirmNicknameChange.addEventListener('click', function() {
          const newNickname = document.getElementById('newNickname').value.trim();
          
          if (!newNickname) {
            alert('새 닉네임을 입력해주세요.');
            return;
          }
          
          if (newNickname.length < 2 || newNickname.length > 10) {
            alert('닉네임은 2~10자 사이여야 합니다.');
            return;
          }
          
          // 재화 확인
          if (user.currency < 1000) {
            alert('닉네임 변경에 필요한 재화가 부족합니다. (1,000 재화 필요)');
            return;
          }
          
          // 닉네임 변경 처리
          user.name = newNickname;
          user.currency -= 1000; // 재화 차감
          
          // 로컬 스토리지 업데이트
          localStorage.setItem('user', JSON.stringify(user));
          
          // UI 업데이트
          document.getElementById('userName').textContent = newNickname;
          document.getElementById('userCurrency').textContent = `${user.currency.toLocaleString()} 재화`;
          
          // 모달 닫기
          nicknameModal.classList.add('hidden');
          
          showToast('닉네임이 변경되었습니다.');
        });
        
        // 비밀번호 변경 모달 열기
        passwordChangeBtn.addEventListener('click', function() {
          passwordModal.classList.remove('hidden');
          document.getElementById('currentPassword').focus();
        });
        
        // 비밀번호 변경 모달 닫기
        closePasswordModal.addEventListener('click', function() {
          passwordModal.classList.add('hidden');
        });
        
        cancelPasswordChange.addEventListener('click', function() {
          passwordModal.classList.add('hidden');
        });
        
        // 비밀번호 변경 확인 처리
        confirmPasswordChange.addEventListener('click', function() {
          const currentPassword = document.getElementById('currentPassword').value;
          const newPassword = document.getElementById('newPassword').value;
          const confirmPassword = document.getElementById('confirmPassword').value;
          
          if (!currentPassword || !newPassword || !confirmPassword) {
            alert('모든 항목을 입력해주세요.');
            return;
          }
          
          if (currentPassword !== user.password) {
            alert('현재 비밀번호가 일치하지 않습니다.');
            return;
          }
          
          if (newPassword !== confirmPassword) {
            alert('새 비밀번호가 확인과 일치하지 않습니다.');
            return;
          }
          
          if (newPassword.length < 8) {
            alert('비밀번호는 최소 8자 이상이어야 합니다.');
            return;
          }
          
          // 비밀번호 변경 처리
          user.password = newPassword;
          
          // 로컬 스토리지 업데이트
          localStorage.setItem('user', JSON.stringify(user));
          
          // 비밀번호 표시 업데이트
          document.getElementById('userPassword').textContent = '*'.repeat(newPassword.length);
          
          // 모달 닫기
          passwordModal.classList.add('hidden');
          
          // 폼 초기화
          document.getElementById('currentPassword').value = '';
          document.getElementById('newPassword').value = '';
          document.getElementById('confirmPassword').value = '';
          
          alert('비밀번호가 변경되었습니다.');
        });
        
        // 최근 거래 내역 표시 (예시 데이터)
        const transactionList = document.getElementById('transactionList');
        const noTransactions = document.getElementById('noTransactions');
        
        // 거래 내역이 있는 경우 샘플 데이터 표시
        if (user.transactions && user.transactions.length > 0) {
          noTransactions.classList.add('hidden');
          
          user.transactions.forEach(transaction => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${transaction.date}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${transaction.item}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${transaction.price.toLocaleString()} 골드</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-${transaction.status === '구매' ? 'blue' : 'green'}-600">${transaction.status}</td>
            `;
            transactionList.appendChild(row);
          });
        }
      } else {
        // 비로그인 상태
        loginBtn.classList.remove('hidden');
        profileLink.classList.add('hidden');
        
        // 프로필 페이지 표시
        notLoggedIn.classList.remove('hidden');
        userProfile.classList.add('hidden');
      }
      
      // 닉네임 변경 버튼 이벤트 핸들러
      const changeNicknameBtn = document.getElementById('changeNicknameBtn');
      if (changeNicknameBtn) {
        changeNicknameBtn.addEventListener('click', function() {
          const newNickname = document.getElementById('newNickname').value.trim();
          
          if (!newNickname) {
            alert('새 닉네임을 입력해주세요.');
            return;
          }
          
          // 현재 사용자 정보 가져오기
          const userData = JSON.parse(localStorage.getItem('user') || 'null');
          if (userData) {
            // 재화 확인
            const userCurrency = userData.currency || 0;
            
            if (userCurrency < 1000) {
              alert('닉네임 변경에는 1,000 재화가 필요합니다.');
              return;
            }
            
            // 재화 차감
            userData.currency = userCurrency - 1000;
            
            // 사용자 정보 업데이트 (API 통신)
            // 실제라면 서버에 전송할 코드
            // fetch('/api/user/update', {
            //   method: 'POST',
            //   headers: { 'Content-Type': 'application/json' },
            //   body: JSON.stringify({ userId: userData.id, nickname: newNickname })
            // })
            // .then(response => response.json())
            // .then(data => {
            //   if (data.success) {
            //     // 성공 처리
            //   }
            // });
          
            // 로컬 테스트용 코드 - 실제로는 위 API 사용
            // 닉네임 업데이트
            userData.name = newNickname;
            
            // 로컬 스토리지에 저장
            localStorage.setItem('user', JSON.stringify(userData));
            
            // 화면 업데이트
            document.getElementById('userName').textContent = newNickname;
            document.getElementById('userCurrency').textContent = `${userData.currency.toLocaleString()} 재화`;
            
            alert('닉네임이 성공적으로 변경되었습니다. (1,000 재화 차감)');
            document.getElementById('newNickname').value = '';
          }
        });
      }
      
      // 비밀번호 변경 버튼 이벤트 핸들러
      const changePasswordBtn = document.getElementById('changePasswordBtn');
      if (changePasswordBtn) {
        changePasswordBtn.addEventListener('click', function() {
          const currentPassword = document.getElementById('currentPassword').value;
          const newPassword = document.getElementById('newPassword').value;
          const confirmPassword = document.getElementById('confirmPassword').value;
          
          if (!currentPassword || !newPassword || !confirmPassword) {
            alert('모든 비밀번호 필드를 입력해주세요.');
            return;
          }
          
          if (newPassword !== confirmPassword) {
            alert('새 비밀번호와 확인 비밀번호가 일치하지 않습니다.');
            return;
          }
          
          // 현재 사용자 정보 가져오기
          const userData = JSON.parse(localStorage.getItem('user') || 'null');
          if (userData) {
            // 현재 비밀번호 확인 (실제 서비스에서는 서버에서 해시 비교)
            if (userData.password !== currentPassword) {
              alert('현재 비밀번호가 일치하지 않습니다.');
              return;
            }
            
            // 비밀번호 업데이트
            userData.password = newPassword;
            
            // 로컬 스토리지에 저장
            localStorage.setItem('user', JSON.stringify(userData));
            
            alert('비밀번호가 성공적으로 변경되었습니다.');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
          }
        });
      }
    });
  </script>
</body>
</html>
